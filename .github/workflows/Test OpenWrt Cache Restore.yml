name: Test OpenWrt Cache Restore

on:
  workflow_dispatch:

jobs:
  test-cache:
    runs-on: ubuntu-latest
    steps:
    
    # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
    - name: Checkout code ğŸ› ï¸
      uses: actions/checkout@v2
      # æ£€å‡ºä»£ç ï¼Œç¡®ä¿æœ‰ OpenWrt æºä»£ç 
    
    # æ­¥éª¤ 2: ç¼“å­˜ OpenWrt çš„ä¸‹è½½ç›®å½•
    - name: Cache OpenWrt downloads ğŸ“¦
      uses: actions/cache@v3
      with:
        path: openwrt/dl
        key: ${{ runner.os }}-openwrt-${{ hashFiles('**/feeds.conf.default') }}
        restore-keys: |
          ${{ runner.os }}-openwrt-
      id: cache-dl

    # æ­¥éª¤ 3: ç¼“å­˜ OpenWrt æ„å»ºç›®å½•
    - name: Cache OpenWrt build directory ğŸ› ï¸
      uses: actions/cache@v3
      with:
        path: |
          openwrt/build_dir
          openwrt/staging_dir
          openwrt/scripts  # ç¡®ä¿ç¼“å­˜ scripts ç›®å½•
        key: ${{ runner.os }}-openwrt-build-${{ hashFiles('**/feeds.conf.default') }}
        restore-keys: |
          ${{ runner.os }}-openwrt-build-
      id: cache-build

    # æ­¥éª¤ 4: ç¡®è®¤ç¼“å­˜æ˜¯å¦å‘½ä¸­
    - name: Check if cache hit ğŸ’¡
      run: |
        echo "Cache Hit: ${{ steps.cache-dl.outputs.cache-hit }}"
        echo "Cache Hit: ${{ steps.cache-build.outputs.cache-hit }}"

    # æ­¥éª¤ 5: éªŒè¯æ˜¯å¦æ¢å¤äº† feeds è„šæœ¬
    - name: Verify that ./scripts/feeds exists ğŸ“‚
      run: |
        ls -l openwrt/scripts
        # è¾“å‡º openwrt/scripts ç›®å½•ï¼Œç¡®ä¿ feeds è„šæœ¬å­˜åœ¨
    
    # æ­¥éª¤ 6: ç¡®ä¿ä»“åº“å…‹éš†å¹¶è¿è¡Œ make defconfig
    - name: Load custom configuration ğŸ§‘â€ğŸ«
      run: |
        cd openwrt
        make defconfig
        # ç¡®ä¿é…ç½®æ–‡ä»¶è¢«æ­£ç¡®åŠ è½½
    
    # æ­¥éª¤ 7: è¿è¡Œ feeds æ›´æ–°å‘½ä»¤
    - name: Update feeds ğŸ”„
      run: |
        cd openwrt
        ./scripts/feeds update -a
        # ç¡®ä¿ feeds æ›´æ–°å‘½ä»¤æˆåŠŸæ‰§è¡Œ

    # æ­¥éª¤ 8: è¾“å‡ºè°ƒè¯•ä¿¡æ¯ï¼Œç¡®ä¿æ­£ç¡®ç”Ÿæˆæ–‡ä»¶å
    - name: Generate firmware filename ğŸ“
      id: generate_filename
      run: |
        VERSION="immortalwrt-21.02"
        TIMESTAMP=$(date '+%Y%m%d')
        FILENAME="RAX3000M_mediatek_mt7981_${VERSION}-${{ github.run_id }}-${TIMESTAMP}"
        echo "Generated firmware filename: $FILENAME"
        echo "FILENAME=$FILENAME" >> $GITHUB_ENV
      # ç”Ÿæˆæ–‡ä»¶åå¹¶è¾“å‡ºè°ƒè¯•ä¿¡æ¯

    # æ­¥éª¤ 9: è¾“å‡ºç”Ÿæˆçš„æ–‡ä»¶å
    - name: Output the generated firmware filename
      run: |
        echo "The generated firmware filename is: ${{ env.FILENAME }}"
      # è¾“å‡ºæ–‡ä»¶åï¼Œæ£€æŸ¥æ˜¯å¦æ­£ç¡®ç”Ÿæˆ
