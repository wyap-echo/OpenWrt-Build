# File: .github/workflows/build-openwrt.yml
# åŸºäº RAX3000M çš„ ImmortalWrt äº‘ç¼–è¯‘å·¥ä½œæµï¼ˆä¼˜åŒ–ä¿®å¤ç‰ˆï¼‰

name: Build RAX3000M Firmware

on:
  workflow_dispatch:  # ä»…æ”¯æŒæ‰‹åŠ¨è§¦å‘ç¼–è¯‘

env:
  # ========== æ ¸å¿ƒé…ç½® ==========
  REPO_URL: https://github.com/hanwckf/immortalwrt-mt798x.git
  REPO_BRANCH: openwrt-21.02       # æºç åˆ†æ”¯
  FEEDS_CONF: feeds.conf.default   # é»˜è®¤ feeds é…ç½®æ–‡ä»¶
  CONFIG_FILE: configs/rax3000m.config  # è®¾å¤‡é…ç½®æ–‡ä»¶
  DIY_P1_SH: diy-part1.sh          # è‡ªå®šä¹‰è„šæœ¬1ï¼ˆæ—©æœŸé…ç½®ï¼‰
  DIY_P2_SH: diy-part2.sh          # è‡ªå®šä¹‰è„šæœ¬2ï¼ˆåæœŸé…ç½®ï¼‰
  TZ: Asia/Shanghai                # æ—¶åŒºè®¾ç½®
  FIRMWARE_NAME: RAX3000M_$(date +"%Y%m%d")  # å›ºä»¶å‘½åè§„åˆ™

jobs:
  build:
    runs-on: ubuntu-latest         # ä½¿ç”¨æœ€æ–° Ubuntu ç¯å¢ƒ

    steps:
    # ========== ä»£ç æ£€å‡º ==========
    - name: Checkout Repository
      uses: actions/checkout@v4    # æ£€å‡ºå½“å‰ä»“åº“ä»£ç ï¼ˆå«è‡ªå®šä¹‰è„šæœ¬ï¼‰
      with:
        submodules: recursive      # é€’å½’æ£€å‡ºå­æ¨¡å—ï¼ˆå¦‚æœ‰ï¼‰

    # ========== ç¼“å­˜æ¢å¤ ==========
    - name: Restore Build Cache
      uses: actions/cache@v3
      with:
        path: |
          /workdir/openwrt/dl      # ç¼“å­˜ä¸‹è½½çš„è½¯ä»¶åŒ…
          /workdir/openwrt/ccache  # ç¼“å­˜ç¼–è¯‘ä¸­é—´æ–‡ä»¶
        key: ${{ runner.os }}-immortalwrt-${{ hashFiles('$FEEDS_CONF') }}-${{ hashFiles('$CONFIG_FILE') }}
        restore-keys: |
          ${{ runner.os }}-immortalwrt-  # ç¼“å­˜å›é€€ç­–ç•¥

    # ========== ç¯å¢ƒåˆå§‹åŒ– ==========
    - name: Setup Build Environment
      env:
        DEBIAN_FRONTEND: noninteractive  # ç¦ç”¨äº¤äº’æç¤º
      run: |
        # æ¸…ç†å†—ä½™ç›®å½•ï¼ˆä¿ç•™APTæºé…ç½®ï¼‰
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc

        # ä¿®å¤APTæºé…ç½®ï¼ˆå…³é”®ä¿®å¤æ­¥éª¤ï¼‰
        sudo sed -i 's/^#\s*deb-src/deb-src/' /etc/apt/sources.list  # å¯ç”¨æºç ä»“åº“
        sudo add-apt-repository -y universe  # å¯ç”¨ universe ä»“åº“

        # å®‰è£…ç¼–è¯‘ä¾èµ–
        sudo apt-get update -qq
        sudo apt-get install -y \
          build-essential \
          ccache \
          libncurses5-dev \
          git \
          python3 \
          rsync

        # åˆå§‹åŒ– ImmortalWrt ç¼–è¯‘ç¯å¢ƒ
        sudo bash <(curl -sL https://build-scripts.immortalwrt.eu.org/init_build_environment.sh)

        # è®¾ç½®æ—¶åŒºå’Œç›®å½•æƒé™
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir && sudo chown $USER:$GROUPS /workdir

    # ========== æºç å…‹éš† ==========
    - name: Clone Source Code
      working-directory: /workdir  # æŒ‡å®šå·¥ä½œç›®å½•
      run: |
        git clone "$REPO_URL" -b "$REPO_BRANCH" openwrt  # å…‹éš†æŒ‡å®šåˆ†æ”¯çš„æºç 

    # ========== è‡ªå®šä¹‰é…ç½®åŠ è½½ ==========
    - name: Apply Custom Configurations
      run: |
        # åŠ è½½è‡ªå®šä¹‰ feeds é…ç½®
        [ -e "$FEEDS_CONF" ] && mv "$FEEDS_CONF" /workdir/openwrt/feeds.conf.default
        
        # æ‰§è¡Œç¬¬ä¸€é˜¶æ®µè‡ªå®šä¹‰è„šæœ¬
        chmod +x "$DIY_P1_SH"
        cd /workdir/openwrt
        "$GITHUB_WORKSPACE/$DIY_P1_SH" || exit 1  # è„šæœ¬å¤±è´¥åˆ™ç»ˆæ­¢

    # ========== ä¾èµ–ç®¡ç† ==========
    - name: Update Feeds
      run: |
        cd /workdir/openwrt
        ./scripts/feeds update -a || exit 1  # å¼ºåˆ¶å¤±è´¥é€€å‡º

    - name: Install Feeds
      run: |
        cd /workdir/openwrt
        ./scripts/feeds install -a || exit 1

    # ========== ç¼–è¯‘å‡†å¤‡ ==========
    - name: Prepare Configuration
      run: |
        # åŠ è½½è®¾å¤‡é…ç½®æ–‡ä»¶
        [ -e "$CONFIG_FILE" ] && mv "$CONFIG_FILE" /workdir/openwrt/.config
        
        # æ‰§è¡Œç¬¬äºŒé˜¶æ®µè‡ªå®šä¹‰è„šæœ¬
        chmod +x "$DIY_P2_SH"
        cd /workdir/openwrt
        "$GITHUB_WORKSPACE/$DIY_P2_SH" || exit 1

    # ========== èµ„æºä¸‹è½½ ==========
    - name: Download Packages
      run: |
        cd /workdir/openwrt
        make defconfig
        echo "CONFIG_CCACHE=y" >> .config  # å¯ç”¨ ccache
        make CCACHE=1 download -j$(($(nproc) + 1))  # å¤šçº¿ç¨‹ä¸‹è½½

    # ========== å›ºä»¶ç¼–è¯‘ ==========
    - name: Compile Firmware
      env:
        CCACHE_MAXSIZE: 2G  # é™åˆ¶ç¼“å­˜å¤§å°
      run: |
        cd /workdir/openwrt
        echo "::notice::ğŸš€ å¼€å§‹ç¼–è¯‘ï¼Œä½¿ç”¨ $(($(nproc) + 1)) çº¿ç¨‹..."
        make CCACHE=1 -j$(($(nproc) + 1)) || { 
          echo "::warning::âš ï¸ ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹é‡è¯•..."; 
          make CCACHE=1 -j1 V=s; 
        }
        echo "FIRMWARE_NAME=$FIRMWARE_NAME" >> $GITHUB_ENV  # æ³¨å…¥å›ºä»¶åç§°

    # ========== å›ºä»¶ä¸Šä¼  ==========
    - name: Upload Firmware Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.FIRMWARE_NAME }}   # æŒ‰æ—¥æœŸå‘½åçš„å›ºä»¶
        path: /workdir/openwrt/bin/targets/*/*/*  # è‡ªåŠ¨åŒ¹é…å›ºä»¶è·¯å¾„
