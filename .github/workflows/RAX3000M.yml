# File: .github/workflows/build-openwrt.yml
# RAX3000M ImmortalWrt å›ºä»¶äº‘ç¼–è¯‘é…ç½®ï¼ˆæœ€ç»ˆä¿®å¤ç‰ˆï¼‰
# åŠŸèƒ½ï¼šè‡ªåŠ¨ç¼–è¯‘ã€ç¼“å­˜åŠ é€Ÿã€å›ºä»¶å‘½åã€äº§ç‰©ä¸Šä¼ 

name: Build RAX3000M Firmware

on:
  workflow_dispatch:  # ä»…æ”¯æŒæ‰‹åŠ¨è§¦å‘ç¼–è¯‘

env:
  # ====== æ ¸å¿ƒé…ç½® ======
  REPO_URL: "https://github.com/hanwckf/immortalwrt-mt798x.git"
  REPO_BRANCH: "openwrt-21.02"         # æºç åˆ†æ”¯
  FEEDS_CONF: "feeds.conf.default"     # é»˜è®¤ feeds é…ç½®
  CONFIG_FILE: "configs/rax3000m.config"  # è®¾å¤‡é…ç½®æ–‡ä»¶
  TZ: "Asia/Shanghai"                  # è®¾ç½®æ—¶åŒºï¼ˆå½±å“æ—¥å¿—æ—¶é—´ï¼‰
  FIRMWARE_NAME: "RAX3000M_$(date +'%Y%m%d')"  # å›ºä»¶åç§°æ¨¡æ¿

jobs:
  build:
    runs-on: ubuntu-latest  # ä½¿ç”¨ GitHub æ‰˜ç®¡çš„ Ubuntu æœ€æ–°ç‰ˆ

    steps:
    # ====== 1. ä»“åº“ä»£ç æ£€å‡º ======
    - name: Checkout Repository
      uses: actions/checkout@v4  # å®˜æ–¹æœ€æ–°æ£€å‡ºæ’ä»¶
      with:
        submodules: recursive    # é€’å½’æ£€å‡ºå­æ¨¡å—ï¼ˆå¦‚å­˜åœ¨ï¼‰

    # ====== 2. æ¢å¤ç¼–è¯‘ç¼“å­˜ ======
    - name: Restore Build Cache
      uses: actions/cache@v3
      with:
        path: |  # ç¼“å­˜ç›®å½•å®šä¹‰
          /workdir/openwrt/dl      # æºç åŒ…ç¼“å­˜
          /workdir/openwrt/ccache  # ç¼–è¯‘ä¸­é—´æ–‡ä»¶ç¼“å­˜
        key: ${{ runner.os }}-immortalwrt-${{ hashFiles('$FEEDS_CONF') }}-${{ hashFiles('$CONFIG_FILE') }}
        restore-keys: |  # ç¼“å­˜å›é€€ç­–ç•¥
          ${{ runner.os }}-immortalwrt-

    # ====== 3. åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ ======
    - name: Setup Build Environment
      env:
        DEBIAN_FRONTEND: noninteractive  # ç¦ç”¨äº¤äº’å¼æç¤º
      run: |
        # æ¸…ç†å†—ä½™ç›®å½•ï¼ˆä¿ç•™ç³»ç»ŸAPTæºé…ç½®ï¼‰
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc

        # ä¿®å¤APTæºé…ç½®ï¼ˆå…³é”®æ­¥éª¤ï¼‰
        sudo sed -i 's/^#\s*deb-src/deb-src/' /etc/apt/sources.list  # å¯ç”¨æºç ä»“åº“
        sudo add-apt-repository -y universe  # å¯ç”¨ universe ä»“åº“

        # å®‰è£…åŸºç¡€ä¾èµ–
        sudo apt-get update -qq
        sudo apt-get install -y \
          build-essential \
          ccache \
          libncurses5-dev \
          git \
          python3 \
          rsync \
          curl  # ç¡®ä¿ä¸‹è½½å·¥å…·å­˜åœ¨

        # ä¿®å¤ç¯å¢ƒåˆå§‹åŒ–è„šæœ¬æ‰§è¡Œæ–¹å¼ï¼ˆé¿å…è¿›ç¨‹æ›¿æ¢é”™è¯¯ï¼‰
        curl -sL https://build-scripts.immortalwrt.eu.org/init_build_environment.sh -o /tmp/init.sh
        sudo bash /tmp/init.sh || { echo "::error::åˆå§‹åŒ–è„šæœ¬æ‰§è¡Œå¤±è´¥"; exit 1; }
        rm -f /tmp/init.sh

        # è®¾ç½®æ—¶åŒºå’Œç›®å½•æƒé™
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir && sudo chown $USER:$GROUPS /workdir

    # ====== 4. å…‹éš†æºç ä»“åº“ ======
    - name: Clone Source Code
      working-directory: /workdir
      run: |
        echo "â–· æ­£åœ¨å…‹éš† ImmortalWrt æºç ..."
        git clone "$REPO_URL" -b "$REPO_BRANCH" openwrt

    # ====== 5. åŠ è½½è‡ªå®šä¹‰é…ç½® ======
    - name: Apply Custom Configuration
      run: |
        # åŠ è½½è‡ªå®šä¹‰ feeds é…ç½®
        [ -e "$FEEDS_CONF" ] && mv "$FEEDS_CONF" /workdir/openwrt/feeds.conf.default

        # åŠ è½½è®¾å¤‡é…ç½®æ–‡ä»¶
        [ -e "$CONFIG_FILE" ] && mv "$CONFIG_FILE" /workdir/openwrt/.config

        # æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬ï¼ˆéœ€è‡ªè¡Œå‡†å¤‡ diy-part1.sh å’Œ diy-part2.shï¼‰
        if [ -f "$DIY_P1_SH" ]; then
          chmod +x "$DIY_P1_SH"
          cd /workdir/openwrt
          "$GITHUB_WORKSPACE/$DIY_P1_SH" || exit 1
        fi

    # ====== 6. æ›´æ–°ä¾èµ–æº ======
    - name: Update Feeds
      run: |
        cd /workdir/openwrt
        ./scripts/feeds update -a || exit 1  # å¤±è´¥ç«‹å³ç»ˆæ­¢

    # ====== 7. å®‰è£…ä¾èµ–åŒ… ======
    - name: Install Feeds Packages
      run: |
        cd /workdir/openwrt
        ./scripts/feeds install -a || exit 1

    # ====== 8. æ‰§è¡Œç¬¬äºŒé˜¶æ®µè‡ªå®šä¹‰é…ç½® ======
    - name: Apply Post-Config Script
      run: |
        if [ -f "$DIY_P2_SH" ]; then
          chmod +x "$DIY_P2_SH"
          cd /workdir/openwrt
          "$GITHUB_WORKSPACE/$DIY_P2_SH" || exit 1
        fi

    # ====== 9. ä¸‹è½½é¢„ç¼–è¯‘åŒ… ======
    - name: Download Packages
      run: |
        cd /workdir/openwrt
        make defconfig
        echo "CONFIG_CCACHE=y" >> .config  # å¼ºåˆ¶å¯ç”¨ ccache
        echo "::notice::â¬ å¼€å§‹ä¸‹è½½ä¾èµ–åŒ…ï¼ˆä½¿ç”¨ $(($(nproc) + 1)) çº¿ç¨‹ï¼‰..."
        make CCACHE=1 download -j$(($(nproc) + 1)) || { 
          echo "::warning::âš ï¸ å¤šçº¿ç¨‹ä¸‹è½½å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹é‡è¯•..."; 
          make CCACHE=1 download -j1 V=s;
        }

    # ====== 10. ç¼–è¯‘å›ºä»¶ ======
    - name: Compile Firmware
      env:
        CCACHE_MAXSIZE: 2G  # é™åˆ¶ç¼“å­˜ä½“ç§¯
      run: |
        cd /workdir/openwrt
        echo "::notice::ğŸš€ å¼€å§‹ç¼–è¯‘ï¼ˆä½¿ç”¨ $(($(nproc) + 1)) çº¿ç¨‹ï¼‰..."
        make CCACHE=1 -j$(($(nproc) + 1)) || { 
          echo "::warning::âš ï¸ ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹è°ƒè¯•æ¨¡å¼..."; 
          make CCACHE=1 -j1 V=s; 
        }
        echo "DEVICE_NAME=$(cat /workdir/openwrt/DEVICE_NAME)" >> $GITHUB_ENV

    # ====== 11. æ•´ç†è¾“å‡ºæ–‡ä»¶ ======
    - name: Organize Artifacts
      run: |
        cd /workdir/openwrt/bin/targets/*/*
        rm -rf packages
        find . -name "*.ipk" -delete  # æ¸…ç†å†—ä½™å®‰è£…åŒ…
        echo "FIRMWARE_PATH=$PWD" >> $GITHUB_ENV

    # ====== 12. ä¸Šä¼ ç¼–è¯‘äº§ç‰© ======
    - name: Upload Firmware Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.FIRMWARE_NAME }}_${{ env.DEVICE_NAME }}  # ç¤ºä¾‹ï¼šRAX3000M_20240315_mediatek-mt7981
        path: ${{ env.FIRMWARE_PATH }}/*.bin  # ä»…ä¸Šä¼ å›ºä»¶æ–‡ä»¶
        retention-days: 7  # äº§ç‰©ä¿ç•™å¤©æ•°

    # ====== 13. ç©ºé—´æ£€æŸ¥ï¼ˆè°ƒè¯•ç”¨ï¼‰=====
    - name: Check Disk Usage
      if: ${{ always() }}  # æ€»æ˜¯æ‰§è¡Œï¼ˆå³ä½¿å¤±è´¥ï¼‰
      run: df -hT
